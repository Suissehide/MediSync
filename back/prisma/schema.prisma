datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

enum Role {
  NONE
  USER
  ADMIN
}

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  password  String
  salt      String
  firstName String?
  lastName  String?
  role      Role    @default(NONE)
}

model PathwayTemplate {
  id    String @id @default(cuid())
  name  String
  color String

  pathways      Pathway[]
  slotTemplates SlotTemplate[]
}

model Pathway {
  id         String   @id @default(cuid())
  startDate  DateTime
  templateID String?

  template PathwayTemplate? @relation(fields: [templateID], references: [id])
  slots    Slot[]
}

model Appointment {
  id                  String               @id @default(cuid())
  startDate           DateTime
  endDate             DateTime
  thematic            String?
  type                String?
  slotID              String
  appointmentPatients AppointmentPatient[]

  slot Slot @relation(fields: [slotID], references: [id])
}

model AppointmentPatient {
  id            String @id @default(cuid())
  appointmentId String
  patientId     String

  accompanying      String?
  status            String?
  rejectionReason   String?
  transmissionNotes String?

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patient     Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, patientId])
}

model SlotTemplate {
  id         String   @id @default(cuid())
  startTime  DateTime @db.Time()
  endTime    DateTime @db.Time()
  offsetDays Int

  isIndividual Boolean
  capacity     Int?
  duration     Int?
  thematic     String?
  location     String?
  description  String?
  color        String

  slot       Slot?
  soignantID String?
  templateID String?

  soignant Soignant?        @relation(fields: [soignantID], references: [id])
  template PathwayTemplate? @relation(fields: [templateID], references: [id])
}

model Slot {
  id             String        @id @default(cuid())
  startDate      DateTime
  endDate        DateTime
  appointments   Appointment[]
  pathwayID      String?
  slotTemplateID String        @unique

  pathway      Pathway?     @relation(fields: [pathwayID], references: [id])
  slotTemplate SlotTemplate @relation(fields: [slotTemplateID], references: [id])
}

model Soignant {
  id   String @id @default(cuid())
  name String

  slotTemplates SlotTemplate[]
  todos         Todo[]
}

model Patient {
  id String @id @default(cuid())

  // Identity
  firstName String
  lastName  String
  gender    String?
  birthDate DateTime?

  // Contact
  phone1 String?
  phone2 String?
  email  String?

  // Personal & Social Info
  distance        String? // Distance d'habitation
  educationLevel  String? // Niveau d’étude
  occupation      String? // Profession
  currentActivity String? // Activité actuelle

  // Referrals & Context
  referringCaregiver String? // Soignant référent
  followUpToDo       String? // Suivi à régulariser

  // Notes
  notes   String?
  details String?

  // Inclusion Data
  medicalDiagnosis     String?
  entryDate            DateTime?
  careMode             String? // Mode de prise en charge
  orientation          String?
  etpDecision          String? // ETP décision
  programType          String?
  nonInclusionDetails  String?
  customContentDetails String?
  goal                 String?

  // Exit Data
  exitDate        DateTime?
  stopReason      String? // Motif d’arrêt de programme
  etpFinalOutcome String? // Point final parcours ETP

  createDate       DateTime
  enrollmentIssues Json?

  appointmentPatients AppointmentPatient[]
}

model Todo {
  id          String   @id @default(cuid())
  createDate  DateTime
  title       String
  description String?
  completed   Boolean

  soignantID String?

  soignant Soignant? @relation(fields: [soignantID], references: [id], onDelete: SetNull)
}
